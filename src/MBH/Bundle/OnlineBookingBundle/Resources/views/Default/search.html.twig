<link rel="stylesheet" href="{{ asset('bundles/mbhonlinebooking/css/search.css', null, true) }}">
<div id="online-booking-search">
{% for result in searchResults %}
<div class="row oneblock room-type-row">
    <!--<div class="sale"></div>-->
    <div class="col-md-4 logo">
        {% set renderedImage = false %}
        {% for searchResult in result.results if not renderedImage %}
            {% if searchResult.roomType.mainImage %}
                <a class="fancybox" href="{{ asset(searchResult.roomType.mainImage.path, null, true) }}" rel="cat{{ loop.parent.loop.index }}">
                    <img class="oblimg" src="{{ asset(searchResult.roomType.mainImage.path|imagine_filter('thumb_275x210'), null, true) }}">
                </a>
                {% set renderedImage = true %}
            {% endif %}
        {% endfor %}
        {% if not renderedImage %}
            {#<div class="placeholder-logo" style="background:url(images/logo-placeholder.png)no-repeat;background-size:cover;"></div>#}
            <img src="{{ asset('bundles/mbhonlinebooking/images/no-image.jpg', null, true) }}">
        {% endif %}
        <div class="row">
            {% if result.results|first.roomType.images is not empty %}
                <div class="col-md-12 miniimages">
                {% for image in result.results|first.roomType.images %}

                        {% if not image.ismain %}
                        <a href="{{ asset(image.path, null, true) }}" class="fancybox" rel="cat{{ loop.parent.loop.index }}">
                            <img src="{{ asset(image.path|imagine_filter('thumb_40x40'), null, true) }}" alt="{{ result.results|first.roomType.name }}">
                        </a>
                        {% endif %}
                {% endfor %}
                </div>
            {% endif %}

        </div>
    </div>
    <div class="col-md-8 right-info">
        <div class="row">
            <div class="col-md-5 col-sm-6 col-xs-12" style="padding:0px;">
                <div class="title">
                    {{ result.roomType.hotel.fullTitle }}&nbsp;
                </div>
                <div class="hotellogo">
                    <img src="{{ asset(result.roomType.hotel.logoUrl, null, true ) }}" alt="{{ result.roomType.hotel.name }}">
                </div>
                <div class="subtitle infocontainer">
                    <div class="pull-left">
                        {#<i class="fa fa-h-square numicon"></i>#}
                        <div class="pull-right roomcon">
                            <div class="roomtype">тип номера</div>
                            <div class="roomname">{{ result.roomType.fullTitle }}</div>
                        </div>

                    </div>
                </div>
                {#<div class="aftersubtitle">#}
                    {#<div class="beforesubtitle">#}
                        {#<i class="fa fa-h-square"></i>#}
                    {#</div>#}
                    {#<div class="ntype">ТИП НОМЕРА</div><div></div>#}

                {#</div>#}
            </div>
            <div class="col-md-7 col-sm-6 col-xs-12 prices">
                <div class="guests pull-left">
                <i class="fa fa-users"></i> Гости <br/>
                {% if result.results|first.adults is defined %}
                    <span class="guestslist">{{ result.results|first.adults }}{{ result.results|first.children?'+'~result.results|first.children }}{{ result.results|first.infants?'+'~result.results|first.infants }}</span>
                {% endif %}
                </div>

                {% set searchResult = result.results|first %}
                <div class=" pull-right">
                    <div style="text-align: center;">СТОИМОСТЬ</div>
                    <span class="newprice">{{ searchResult.getPrice(searchResult.adults, searchResult.children)|number_format(0, thousandSep=' ') }}&nbsp;<i class="fa fa-ruble rublesize"></i></span>
                    {% if result.results|length > 1 %}&nbsp;
                    <span class="oldprice">{{ result.results|last.getPrice(searchResult.adults, searchResult.children)|number_format(0, thousandSep=' ') }}&nbsp;<i class="fa fa-ruble rublesize"></i></span>
                    {% endif %}
                </div>
            </div>
            <div class="row">
                <div class="descr col-xs-12">
                    {{ searchResult.roomTypeInterfaceObject.description|raw }}
                </div>

            </div>
        </div>

        <table class="table table-hover table-striped">
            <thead>
            <tr>
                <th style="width:220px;">
                    <i class="fa fa-tag"></i>&nbsp;Тариф
                </th>
                <th>
                    <i class="fa fa-calendar"></i>&nbsp;Дата
                </th>
                <th >
                    <i class="fa fa-clock-o"></i>&nbsp;Ночи
                </th>
                <th>
                    <i class="fa fa-ruble"></i>&nbsp;Цена
                </th>
                <th></th>
            </tr>
            </thead>
            <tbody>
            {% for searchResult in result.results %}
            <tr class="tariff-row" data-url="{{ requestSearchUrl }}?step=2&form[adults]={{ searchResult.adults }}&form[children]={{ searchResult.children }}&form[begin]={{ searchResult.begin|date('d.m.Y') }}&form[end]={{ searchResult.end|date('d.m.Y') }}&form[roomType]={{ searchResult.roomType.id }}&form[tariff]={{ searchResult.tariff.id }}&form[total]={{ searchResult.getPrice(searchResult.adults, searchResult.children) }}&form[infants]={{ searchResult.infants }}">
                <td >{{ searchResult.tariff.fullTitle }}
                    {% if searchResult.tariff.description is not empty  %}
                        <i class="fa fa-question-circle" data-toggle="tooltip" title="{{ searchResult.tariff.description }}"></i>
                    {% endif %}
                </td>

                <td>
                    {% if searchResult.begin|date('Y') == 'now'|date('Y') %}
                        {% set format = 'd MMM' %}
                    {% else %}
                        {% set format = 'd MMM y' %}
                    {% endif %}
                    <span style="white-space: nowrap;">
                    {{ searchResult.begin|localizeddate('medium', 'none', 'ru', null, format) }}
                    </span><br>
                    {% if searchResult.end|date('Y') == 'now'|date('Y') %}
                        {% set format = 'd MMM' %}
                    {% else %}
                        {% set format = 'd MMM y' %}
                    {% endif %}
                    <span style="white-space: nowrap;">
                    {{ searchResult.end|localizeddate('medium', 'none', 'ru', null, format) }}
                    </span>
                </td>
                <td class="text-center">
                    {{ searchResult.nights }}
                </td>
                <td nowrap>
                    {{ searchResult.getPrice(searchResult.adults, searchResult.children)|number_format(0, thousandSep=' ') }}
                </td>
                <td>
                    <input type="radio" name="booking-{{ searchResult.roomType.id }}">
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
        <div class="btmactions">
            <a href="#" class="btn btn-default btn-booking-reservation disabled" title="Отправить заявку" >Отправить заявку</a>
            <a href="#" class="btn btn-warning btn-booking" title="Купить онлайн">Купить онлайн</a>
        </div>



    </div>
</div>
{% endfor %}
</div>

{% if searchResults|length == 0 %}
    <div style="background-color: #FFFFFF; padding: 15px">
        <strong><i class="fa fa-exclamation"></i> Варианты не найдены.</strong>
            <p>Пожалуйста, проверьте даты заезда и выезда.</p>
            <p>Или свяжитесь с нами: по телефону 8 (800) 775-15-41 (звонок бесплатный по всей России) или написав нам через форму обратной связи.</p>
            <p>Мы обязательно Вам поможем!</p>
            <p>Спасибо, что выбираете Курортную сеть «Азовский»</p>
        <p><strong>Смотрите также: </strong><a href="http://azovsky.ru/specpredlojenia-dnia/">Спецпредложения</a></p>
    </div>
{% endif %}


{#% for result in searchResults %}
<div class="row" id="online-booking-search">
    <div class="well col-lg-12 room-type-row">
        <h4></h4>
        <div class="row">
            <div class="col-md-10">
                {% for searchResult in result.results %}
                <div class="row tariff-row" data-url="{{ requestSearchUrl }}?step=2&form[adults]={{ searchResult.adults }}&form[children]={{ searchResult.children }}&form[begin]={{ searchResult.begin|date('d.m.Y') }}&form[end]={{ searchResult.end|date('d.m.Y') }}&form[roomType]={{ searchResult.roomType.id }}&form[tariff]={{ searchResult.tariff.id }}&form[total]={{ searchResult.getPrice(searchResult.adults, searchResult.children) }}">
                    <div class="col-md-4" style="font-weight: bold">Тариф: {{ searchResult.tariff }}</div>
                    <div class="col-md-4">
                        Взрослых: <br>
                        Даты: <br>
                        Количество комнат: {{ searchResult.roomsCount }}<br>
                        Цена: {{ searchResult.getPrice(searchResult.adults, searchResult.children)|number_format(0, thousandSep=' ') }}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="pull-right">
            <a class="btn btn-success btn-sm" href="">Бронировать</a>
        </div>
    </div>
</div>
{% endfor %#}

{#<link href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">#}
{#<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.min.js"></script>#}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Readmore.js/2.2.0/readmore.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/iCheck/1.0.2/icheck.min.js"></script>

<script>
    $(function () {
        console.log($("#search_form").serialize());

        $('.descr').readmore({
            moreLink: '<div class="more-link"><a href="#">... <i class="fa fa-caret-right"></i></a></div>',
            lessLink: '<div class="less-link"><a href="#">... <i class="fa fa-caret-up"></i></a></div>',
            collapsedHeight: 45
        });

//        $('.table').readmore({
//            moreLink: '<div class="more-link"><a href="#">еще предложения <i class="fa fa-caret-right"></i></a></div>',
//            lessLink: '<div class="less-link"><a href="#">... <i class="fa fa-caret-up"></i></a></div>',
//            collapsedHeight: 120
//        });
    });
</script>
<script>
    //Send notification

    //BuyOnline
    var RoomTypeRow = function($row) {
        this.$row = $row;
        this.$bookingButton = $row.find('.btn-booking');
        this.tariffRows = [];
        this.selectedTariffRow = null;
    }

    /*RoomTypeRow.prototype.isSelected = function()
    {
        return this.selectedTariffRow;
    }*/

    RoomTypeRow.prototype.update = function()
    {
        this.notAlreadyBooking();
        this.tariffRows.forEach(function(t) {
            t.update();
        })
    }

    RoomTypeRow.prototype.init = function()
    {
        this.bindEventHandlers();
        this.initTariff();
        this.update();
    }

    RoomTypeRow.prototype.bindEventHandlers = function()
    {

    }

    RoomTypeRow.prototype.initTariff = function()
    {
        var that = this;
        this.$row.find('.tariff-row').each(function() {
            var tariffRow = new TariffRow($(this), that);
            tariffRow.init();
            that.tariffRows.push(tariffRow);
        })
    }

    RoomTypeRow.prototype.notAlreadyBooking = function()
    {
        this.$bookingButton.addClass('disabled').attr('href', '');
        /*this.tariffRows.forEach(function(index, t) {
            tariffRow.notSelected();
        })*/
    }

    RoomTypeRow.prototype.alreadyBooking = function(tariffRow)
    {
        this.tariffRows.forEach(function(t) {
            if (t != tariffRow) {
                t.notSelected()
            }
        })

        this.reBuildHref();
    }

    RoomTypeRow.prototype.reBuildHref = function()
    {
        var href = this.selectedTariffRow.bookingHref;
        if (this.selectedTariffRow.$promotionSelect.val()) {
            href = href + '&form[promotion]=' + this.selectedTariffRow.$promotionSelect.val()+ $("#search_form").serialize();
        }
        this.$bookingButton.removeClass('disabled').attr('href', href);
    }

    var TariffRow = function($row, roomTypeRow) {
        this.$row = $row;
        this.$radiobutton = this.$row.find('input[type=radio]');
        this.bookingHref = this.$row.data('url');
        this.$promotionSelect = $row.find('select');
        this.roomTypeRow = roomTypeRow;
    }

    TariffRow.prototype.init = function()
    {
        this.bindEventHandlers();
    }

    TariffRow.prototype.isSelected = function()
    {
        return this.$radiobutton.is(':checked');
    }

    TariffRow.prototype.update = function()
    {
        if (this.isSelected()) {
            this.selected();
        }
    }

    TariffRow.prototype.bindEventHandlers = function()
    {
        var that = this;
        this.$radiobutton.on('ifChanged', function() {
            that.selected();
        })
        this.$promotionSelect.on('change', function() {
            that.roomTypeRow.selectedTariffRow = that;
            that.roomTypeRow.reBuildHref();
        })
    }

    TariffRow.prototype.selected = function()
    {
        this.roomTypeRow.selectedTariffRow = this;
        //this.$promotionSelect.removeClass('hide');
        this.$radiobutton.iCheck('check');
        this.roomTypeRow.alreadyBooking(this);
    }

    TariffRow.prototype.notSelected = function()
    {
        this.$promotionSelect.addClass('hide');
        //this.$radiobutton.attr('checked', false);
    }

    var $onlineBookingSearch = $('#online-booking-search');
    $onlineBookingSearch.ready(function() {
        $onlineBookingSearch.find('.fancybox').fancybox();

        var $roomTypeRows = $onlineBookingSearch.find('.room-type-row');
        $roomTypeRows.each(function() {
            var roomTypeRow = new RoomTypeRow($(this));
            roomTypeRow.init();

            roomTypeRow.tariffRows.forEach(function(tariffRow) {
                tariffRow.$row.on('click', function() {
                    tariffRow.selected();
                    start_bron(this);
                });
            })
        });
    });

    var start_bron = function(row) {
        var $button_reservation = $(row).closest("table").siblings(".btmactions").find("a.btn-booking-reservation");
        if($button_reservation.hasClass("disabled")) {
            $button_reservation.removeClass("disabled");
        }
        console.log(row);
        var href = $(row).data("url");
        href = href + '&reservation=true';
        $button_reservation.attr("href", href )
        console.log(href);

    };
</script>

<style>
    #online-booking-search .right-info .table tbody tr {
        cursor: pointer;
    }
</style>