<link rel="stylesheet" href="{{ absolute_url(asset('bundles/mbhonlinebooking/css/ssearch.css')) }}">
<script src="https://code.highcharts.com/stock/highstock.js"></script>
<script src="{{ absolute_url(asset('assets/vendor/admin-lte/plugins/iCheck/icheck.min.js')) }}"></script>
<link rel="stylesheet" href="{{ absolute_url(asset('assets/vendor/iCheck/skins/square/_all.css')) }}">

<div id="online-booking-search">
    <p class="restitle">Курортная сеть "Азовский": варианты размещения в выбранные объекты</p>
    <div class="infoIncludeN">
        Что входит в стоимость путевки:
        <a href="http://azovsky.ru/putevka-v-Crimea/" target="_blank">Азовский</a>,
        <a href="http://azovsky.ru/azovland/azovland-putevka/" style="" target="_blank">АзовЛенд</a>
    </div>

    {#<section>
        <div class="oneblockinrdm specgrblock">
            <div class="leftrdm">
                <div class="imghotel"
                     style="background:url(http://az.maxibooking.ru/media/cache/thumb_275x210/upload/roomTypes/1480070422675.jpeg)no-repeat;background-size:cover;">
                    <div class="inghotelline">
                        <img src="http://az.maxibooking.ru/media/cache/thumb_40x40/upload/roomTypes/1480070428565.jpeg"
                             alt="">
                        <img src="http://az.maxibooking.ru/media/cache/thumb_40x40/upload/roomTypes/1480070435451.jpeg"
                             alt="">
                    </div>
                </div>
            </div>
            <div class="rightrdm">
                <div class="leftinrdm">
                    <p class="titlerdm">Пансионат Азовский</p>
                    <p class="numtype"><b>Тип номера:</b><br>Домики с верандой (МАХ 3)</p>
                    <p class="gueststype"><b>Гости:</b> 2 взр. + 1 реб.</p>
                    <p class="eattype">
                        <img src="images/vl.png" alt="">

                        3-разовое питание<br>шведский стол</p>
                    <div class="iconstype"><!--<img src="/images/icns.png" alt="">-->
                        <i class="mbf-clock"></i>
                        <i class="mbf-sofa"></i>
                        <i class="mbf-shower"></i>
                        <i class="mbf-stake"></i>
                    </div>
                </div>
                <div class="rightinrdm">
                    <p class="titlerdm">Цена за 25 ночей</p>
                    <div class="clear"></div>
                    <p class="pricerdm"><span class="noneprice">127 640&#8381;</span>
                        <span class="newprice">156 140&#8381;</span>
                    </p>
                    <p class="datesrdm">18.07.17 - 28.07.17</p>
                    <p class="daysrdm">26 дней / 25 ночей</p>
                    <p class="lastrdm">осталось 3 номера</p>
                    <p class="bronsrdm">забронировано сегодня 9 раз</p>
                </div>
                <div class="clear"></div>
            </div>
            <div class="clear"></div>
            <div class="lefttblrdm">
                <table class="pricetbl">
                    <tr class="flinetbl">
                        <td>Тариф</td>
                        <td>Скидка</td>
                        <td>Цена</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>Раннее бронирование 2017 при 100% оплате</td>
                        <td class="redtd">-25%</td>
                        <td>15670&#8381;</td>
                        <td><input name="var" type="radio" value=""></td>
                    </tr>
                    <tr>
                        <td>Раннее бронирование 2017 при 100% оплате</td>
                        <td class="redtd">-25%</td>
                        <td>15670&#8381;</td>
                        <td><input name="var" type="radio" value=""></td>
                    </tr>
                    <tr>
                        <td>Раннее бронирование 2017 при 100% оплате</td>
                        <td class="redtd">-25%</td>
                        <td>15670&#8381;</td>
                        <td><input name="var" type="radio" value=""></td>
                    </tr>
                </table>
            </div>
            <div class="righttblrdm">
                <div class="spros">Пользуется спросом!</div>
                <p class="btmone">Отправить заявку</p>
                <p class="btmtwo">Купить онлайн</p>
                <p class="btmthree">Смотреть другие спецпредложения</p>

            </div>
            <div class="clear"></div>
        </div>
    </section>#}


    {% for offerByRoomType in searchResults %}
        {% set roomType, tariffResults, query, children = offerByRoomType.roomType, offerByRoomType.results, offerByRoomType.query, offerByRoomType.query.children %}
        {{ dump(roomType, tariffResults, query) }}
    <section>
        <div class="oneblockinrdm room-type-row" data-roomtype="{{ roomType.id }}">
            <div class="leftrdm">
                <div class="imghotel"
                     style="background:url(http://az.maxibooking.ru/media/cache/thumb_275x210/upload/roomTypes/1480070422675.jpeg)no-repeat;background-size:cover;">
                    <div class="inghotelline">
                        <img src="http://az.maxibooking.ru/media/cache/thumb_40x40/upload/roomTypes/1476108079636.jpeg"
                             alt="">
                        <img src="http://az.maxibooking.ru/media/cache/thumb_40x40/upload/roomTypes/1481200742213.jpeg"
                             alt="">
                        <img src="http://az.maxibooking.ru/media/cache/thumb_40x40/upload/roomTypes/1481200753688.jpeg"
                             alt="">
                    </div>
                </div>
            </div>
            <div class="rightrdm">
                <div class="leftinrdm">
                    <p class="titlerdm">{{ roomType.hotel.fullTitle }}&nbsp;</p>
                    <p class="numtype"><b>Тип номера:</b><br>roomType.fullTitle</p>
                    <p class="gueststype">
                        <b>Гости:</b>
                        {{ query.adults }} взр. +
                        {% transchoice children %}
                        {0}{2} %children% реб |]5,Inf[ %children% дет.
                        {% endtranschoice %}
                    </p>
                    <p class="eattype"><img src="images/vl.png" alt=""> 3-разовое питание<br>шведский стол</p>
                    <div class="iconstype"><img src="/images/icns.png" alt=""></div>
                </div>
                <div class="rightinrdm">
                    <p class="titlerdm">Цена за 25 ночей</p>
                    <div class="clear"></div>
                    <p class="pricerdm"><span>127 640&#8381;</span> 156 140&#8381;</p>
                    <p class="datesrdm">18.07.17 - 28.07.17</p>
                    <p class="daysrdm">26 дней / 25 ночей</p>
                    <p class="lastrdm">осталось 3 номера</p>
                    <p class="bronsrdm">забронировано сегодня 9 раз</p>
                </div>
                <div class="clear"></div>
            </div>
            <div class="clear"></div>
            <div class="lefttblrdm">
                <table class="pricetbl">
                    <tr class="flinetbl">
                        <td>Тариф</td>
                        <td>Скидка</td>
                        <td>Цена</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>Раннее бронирование 2017 при 100% оплате</td>
                        <td class="redtd">-25%</td>
                        <td>15670&#8381;</td>
                        <td><input name="var" type="radio" value=""></td>
                    </tr>
                    <tr>
                        <td>Раннее бронирование 2017 при 100% оплате</td>
                        <td class="redtd">-25%</td>
                        <td>15670&#8381;</td>
                        <td><input name="var" type="radio" value=""></td>
                    </tr>
                    <tr>
                        <td>Раннее бронирование 2017 при 100% оплате</td>
                        <td class="redtd">-25%</td>
                        <td>15670&#8381;</td>
                        <td><input name="var" type="radio" value=""></td>
                    </tr>
                </table>
            </div>
            <div class="righttblrdm">
                <div class="spros">Пользуется спросом!</div>
                <p class="btmone btmonenotspec">Отправить заявку</p>
                <p class="btmtwo">Купить онлайн</p>

            </div>
            <div class="clear"></div>
        </div>
    </section>
    {% endfor %}

        {% for result in searchResults %}
        <div class="row oneblock room-type-row" data-roomtype="{{ result.roomType.id }}">
            <div class="col-md-4 logo">
                {% set renderedImage = false %}
                {% for searchResult in result.results if not renderedImage %}
                    {% if searchResult.roomType.mainImage %}
                        <a class="fancybox" href="{{ absolute_url(asset(searchResult.roomType.mainImage.path)) }}"
                           rel="cat{{ loop.parent.loop.index }}">
                            <img class="oblimg"
                                 src="{{ absolute_url(asset(searchResult.roomType.mainImage.path|imagine_filter('thumb_275x210'))) }}">
                        </a>
                        {% set renderedImage = true %}
                    {% endif %}
                {% endfor %}
                {% if not renderedImage %}
                    <div class="placeholder-logo" style="background:url(images/logo-placeholder.png)no-repeat;background-size:cover;"></div>
                    <img src="{{ absolute_url(asset('bundles/mbhonlinebooking/images/no-image.jpg')) }}">
                {% endif %}
                <div class="row">
                    {% if result.results|first.roomType.images is not empty %}
                        <div class="col-md-12 miniimages">
                            {% for image in result.results|first.roomType.images %}

                                {% if not image.ismain %}
                                    <a href="{{ absolute_url(asset(image.path)) }}" class="fancybox"
                                       rel="cat{{ loop.parent.loop.index }}">
                                        <img src="{{ absolute_url(asset(image.path|imagine_filter('thumb_40x40'))) }}"
                                             alt="{{ result.results|first.roomType.name }}">
                                    </a>
                                {% endif %}
                            {% endfor %}
                        </div>
                    {% endif %}

                </div>
            </div>
            <div class="col-md-8 right-info">
                <div class="row">
                    <div class="col-md-5 col-sm-6 col-xs-12" style="padding:0px;">
                        <div class="title">
                            {{ result.roomType.hotel.fullTitle }}&nbsp;
                        </div>
                        <div class="hotellogo">
                            <img src="{{ absolute_url(asset(result.roomType.hotel.logoUrl)) }}"
                                 alt="{{ result.roomType.hotel.name }}">
                        </div>
                        <div class="subtitle infocontainer">
                            <div class="pull-left">
                                <i class="fa fa-h-square numicon"></i>
                                <div class="pull-right roomcon">
                                    <div class="roomtype">тип номера</div>
                                    <div class="roomname">

                                        {% if result.roomType.descriptionurl is defined and result.roomType.descriptionurl is not empty %}
                                            <a href="{{ result.roomType.descriptionUrl }}"
                                               target="_blank">{{ result.roomType.fullTitle }}</a>
                                        {% else %}
                                            {{ result.roomType.fullTitle }}
                                        {% endif %}

                                    </div>
                                </div>

                            </div>
                        </div>

                    </div>
                    <div class="col-md-7 col-sm-6 col-xs-12 prices">
                        <div class="guests pull-left">
                            <i class="fa fa-users"></i> Гости <br/>
                            {% if result.results|first.adults is defined %}
                                <span class="guestslist">{{ result.results|first.adults }}{{ result.results|first.children?'+'~result.results|first.children }}{{ result.results|first.infants?'+'~result.results|first.infants }}</span>
                            {% endif %}
                        </div>

                        {% set searchResult = result.results|first %}
                        <div class=" pull-right">
                            <div style="text-align: center;">СТОИМОСТЬ</div>
                            <span class="newprice">{{ searchResult.getPrice(searchResult.adults, searchResult.children)|number_format(0, thousandSep=' ') }}
                                &nbsp;<i class="fa fa-ruble rublesize"></i></span>
                            {% if result.results|length > 1 %}&nbsp;
                                <span class="oldprice">{{ result.results|last.getPrice(result.results|last.adults, result.results|last.children)|number_format(0, thousandSep=' ') }}
                                    &nbsp;<i class="fa fa-ruble rublesize"></i></span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="row">
                        <div class="descr col-xs-12">
                            {{ searchResult.roomTypeInterfaceObject.description|raw }}
                        </div>

                    </div>
                </div>

                <table class="table table-hover table-row">
                    <thead>
                    <tr>
                        <th style="width:220px;">
                            <i class="fa fa-tag"></i>&nbsp;Тариф
                        </th>
                        <th>
                            <i class="fa fa-calendar"></i>&nbsp;Дата
                        </th>
                        <th>
                            <i class="fa fa-clock-o"></i>&nbsp;Ночи
                        </th>
                        <th>
                            <i class="fa fa-ruble"></i>&nbsp;Цена
                        </th>
                        <th></th>
                    </tr>
                    </thead>
                    <tbody class="tariff-container">
                    {% for searchResult in result.results %}
                        {{ include('@MBHOnlineBooking/Default/tariff.html.twig') }}
                    {% endfor %}

                    </tbody>
                </table>
                <div class="btmactions">
                    <a href="javascript:void(0)" tabindex="0" class="btn btn-default btn-booking-all"
                       title="Отправить заявку">ВСЕ ПРЕДЛОЖЕНИЯ</a>
                    <a href="javascript:void(0)" tabindex="1" class="btn btn-default btn-booking-reservation"
                       title="Отправить заявку">ОТПРАВИТЬ ЗАЯВКУ</a>
                    <a href="javascript:void(0)" tabindex="2" class="btn btn-warning btn-booking" title="Купить онлайн">КУПИТЬ
                        ОНЛАЙН</a>
                </div>
            </div>

            <div id="chart{{ loop.index }}" class="col-md-12"></div>
        </div>

    {% endfor %}

    {% if searchResults|length != 0 %}
        <div class="infoIncludeN">Что входит в стоимость путевки:
            <a href="http://azovsky.ru/putevka-v-Crimea/" target="_blank">Азовский</a>,
            <a href="http://azovsky.ru/azovland/azovland-putevka/" target="_blank">АзовЛенд</a></div>
    {% endif %}
</div>

{% if searchResults|length == 0 %}
    <div style="background-color: #FFFFFF; padding: 15px">
        <strong><i class="fa fa-exclamation"></i> Варианты не найдены.</strong>
        <p>Пожалуйста, проверьте даты заезда и выезда.</p>
        <p>Или свяжитесь с нами: по телефону 8 (800) 775-15-41 (звонок бесплатный по всей России) или написав нам через
            <a href="/mail-us">форму обратной связи</a>.</p>
        <p>Мы обязательно Вам поможем!</p>
        <p>Спасибо, что выбираете Курортную сеть «Азовский»</p>
        <p><strong>Смотрите также: </strong><a href="http://azovsky.ru/specpredlojenia-dnia/">Спецпредложения</a></p>
    </div>
{% endif %}

<script>
    var mychart, myprices, myrows = [];

    //BuyOnline
    var RoomTypeRow = function ($row) {
        this.$row = $row;
        this.$bookingButton = $row.find('.btn-booking');
        this.$bookingButtonReservation = $row.find('.btn-booking-reservation');
        this.$bookingButtonAll = $row.find('.btn-booking-all');
        this.tariffRows = [];
        this.selectedTariffRow = null;
        this.chartContainer = this.$row.find("div[id^=chart]").attr('id');
        this.roomTypeId = this.$row.data('roomtype');
    };

    RoomTypeRow.prototype.init = function () {
        this.initTariffs();
        this.bindEventHandlers();
    };

    RoomTypeRow.prototype.initTariffs = function () {
        var that = this;
        this.$row.find('.tariff-row').each(function () {
            var tariffRow = new TariffRow($(this));
            tariffRow.init(that);
            that.tariffRows.push(tariffRow);
        });
        if (!this.selectedTariffRow) {
            this.tariffRows[0].setCheck();
        }
    };

    RoomTypeRow.prototype.bindEventHandlers = function () {
        var that = this;
        this.$bookingButtonAll.on('click', function (e) {
            e.preventDefault();
            e.stopPropagation();
            that.allTariffAction();
        });

    };

    RoomTypeRow.prototype.selectActiveTariff = function (tariffRow) {
        this.selectedTariffRow = tariffRow;
        this.reBuildHref();
    };

    RoomTypeRow.prototype.allTariffAction = function () {
        //TODO: Сделать затемнение
        var that = this;
        var formData = $("form#search-form").serialize();
        formData = formData +
            '&' + encodeURIComponent('search_form[roomType]') + '=' + this.roomTypeId +
            '&getalltariff=true';
        var ajax = $.get({
                url: Routing.generate('online_booking', {}, true),
                data: formData
            }
        );

        ajax.done(function (data) {
            that.removeTariffs();
            that.addTariffs(data);
        });
    };

    RoomTypeRow.prototype.addTariffs = function (html) {
        this.$row.find('.tariff-container').append(html);
        this.initTariffs();
    };

    RoomTypeRow.prototype.removeTariffs = function () {
        while (this.tariffRows.length) {
            var tariffRow = this.tariffRows.pop();
            tariffRow.selfRemove();
        }
        if (this.selectedTariffRow) {
            this.selectedTariffRow = null;
        }
    };

    RoomTypeRow.prototype.reBuildHref = function () {
        console.log('rebuild href');
        var href = this.selectedTariffRow.bookingHref;
        /*if (this.selectedTariffRow.$promotionSelect.val()) {
         href = href + '&form[promotion]=' + this.selectedTariffRow.$promotionSelect.val();
         }*/
        var form_href = '&' + $("form#search-form").serialize();
        href = href + form_href;

        this.$bookingButton.attr('href', href);
        this.$bookingButtonReservation.attr('href', href + '&reservation=true');
    };

    RoomTypeRow.prototype.handleChartData = function (data) {
        var chartData = data;
        $.each(this.tariffRows, function (index) {
            this.chartData = chartData[index];
        });

    };
    RoomTypeRow.prototype.getChartOptions = function () {
        return {
            chart: {
                type: 'column',
                plotBorderWith: 1,
                height: 250,
                zoomType: false
            },
            title: {
                text: 'Календарь цен',
                align: 'center',
                floating: false
            },
            subtitle: {
                text: 'subtitle',
                floating: true
            },
            xAxis: {
                gridLineWidth: 0,
                type: 'category',
                labels: {
                    rotation: -75,
                    style: {
                        fontSize: '10px',
                        fontFamily: 'Verdana, sans-serif'
                    }
                }
            },
            yAxis: {
                gridLineWidth: 1,
                title: {
                    enabled: false,
                    text: 'Цена'
                },
                allowDecimail: false,
                labels: {
                    enabled: false,
                    format: '{value:,.0f} р'
                },
                tickInterval: 2000
            },
            scrollbar: {
                enabled: true,
                liveRedraw: true
            },
            legend: {
                enabled: false
            },
            plotOptions: {
                series: {
                    color: '#6894ee',
                    align: 'right',
                    allowPointSelect: false,
                    cursor: 'pointer',
                    dataLabels: {
                        format: '{point.y:,.0f} р',
                        enabled: true,
                        rotation: -90,
                        y: 30,
                        color: '#FFFFFF',
                        style: {
                            "fontSize": '10px',
                            "textShadow": false,
                            "textWeight": 100,
                            "stroke-width": "0px"
                        }
                    }
                },
                line: {
                    dataLabels: {
                        enabled: false
                    }
                }
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.85)',
                style: {
                    color: '#F0F0F0'
                },
                headerFormat: '<span style="font-size: 10px; text-align: center;">{point.key}</span><br/>',
                pointFormat: '<b>{point.y} руб.</b>'
            }
        };
    };


    var TariffRow = function ($row) {
        this.$row = $row;
        this.$radiobutton = this.$row.find('input[type=radio]');
        this.bookingHref = this.$row.data('url');
        this.roomTypeRow = null;
        this.chartData = {};
    };

    TariffRow.prototype.init = function (roomTypeRow) {
        var that = this;
        this.roomTypeRow = roomTypeRow;
        this.$radiobutton.iCheck({
            checkboxClass: 'icheckbox_square-green',
            radioClass: 'iradio_square-green',
            increaseArea: '20%' // optional
        });
        this.$radiobutton.on('ifChecked', function (e) {
            that.roomTypeRow.selectActiveTariff(that);
            that.$row.addClass('alerting').siblings().removeClass("alerting");
        });
        if (this.isSelected()) {
            this.setCheck();
        }

    };

    TariffRow.prototype.setCheck = function () {
        this.$radiobutton.iCheck('check');
    };

    TariffRow.prototype.selfRemove = function () {
        this.$row.remove();
    };

    TariffRow.prototype.isSelected = function () {
        return this.$radiobutton.is(':checked');
    };

    TariffRow.prototype.showChart = function () {
        if (!this.roomTypeRow.chart) {
            var options = this.roomTypeRow.getChartOptions();
            options.xAxis.min = this.chartData['showBegin'];
            options.xAxis.max = this.chartData['showEnd'];
            options.subtitle.text = this.chartData['roomTypeName'];
            options.yAxis.max = this.chartData['yMax'];
            options.yAxis.min = this.chartData['yMin'];

            this.roomTypeRow.chart = new Highcharts.Chart(this.roomTypeRow.chartContainer, options);
        }

        //Алярма!, массив с данными передается по ссылке  - по-умолчанию по сему
        //тут копия, которую и передаем. -3чч
        var prices = JSON.parse(JSON.stringify(this.chartData['prices']));

        if ('undefined' == typeof (this.roomTypeRow.chart.series[0])) {
            this.roomTypeRow.chart.addSeries({data: prices});
        } else {
            this.roomTypeRow.chart.series[0].setData(prices);
        }
    };

    TariffRow.prototype.drawChart = function () {
        var data = this.chartData,
            that = this;
        if ($.isEmptyObject(data)) {
            //Для одного тарифа
            //data = $.getJSON(getChartUrl(this))
            //Для всех тарифов
            data = $.getJSON(getChartRoomUrl(this));

            $.when(data).then(function (data) {
                //Закидываем данные в каждый tariffRow через roomType
                that.roomTypeRow.handleChartData(data);
                that.showChart();
            });
        } else {
            this.showChart();
        }

    };


    var getChartRoomUrl = function (tariffRow) {
        var data = [];
        var RoomTypeRow = tariffRow.roomTypeRow;
        RoomTypeRow.tariffRows.forEach(function (tariffRow) {
            var $row = tariffRow.$row;
            data.push({
                roomType: $row.data('roomtype'),
                tariff: $row.data('tariff'),
                adults: $row.data('adults'),
                children: $row.data('children'),
                begin: $row.data('begin'),
                end: $row.data('end')
            });
        });

        return Routing.generate('online_booking_calculationRoom',
            {
                data: JSON.stringify(data)

            }
            , true);
    };

    var $onlineBookingSearch = $('#online-booking-search');
    $onlineBookingSearch.ready(function () {
        $onlineBookingSearch.find('.fancybox').fancybox();

        var $roomTypeRows = $onlineBookingSearch.find('.room-type-row');
        $roomTypeRows.each(function () {
            var roomTypeRow = new RoomTypeRow($(this));
            roomTypeRow.init();
            //Графики - нужно будет перенести в методы
//            roomTypeRow.tariffRows.forEach(function (tariffRow) {
            {#tariffRow.$row.on('click', function () {#}
            {#if ({{ useCharts?'true':'false' }}) {#}
            {#tariffRow.drawChart();#}
            {#}#}
//                    tariffRow.selected();
//                    start_bron(this);
            {#});#}
//            })
        });

    });


</script>